name: Code Quality

on:
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  go-quality:
    name: Go Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: go.sum

      - name: Install Go dependencies
        run: go mod download

      - name: Check Go formatting
        run: |
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "The following files are not formatted:"
            echo "$unformatted"
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

  frontend-quality:
    name: Frontend Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint

      - name: Check TypeScript types
        working-directory: ./frontend
        run: npx tsc --noEmit

  commit-message:
    name: Commit Message Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit message format
        run: |
          # Get commits in PR
          commits=$(git log --format="%s" origin/${{ github.base_ref }}..HEAD)
          
          # Check conventional commit format
          while IFS= read -r commit_msg; do
            if ! echo "$commit_msg" | grep -qE '^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+'; then
              echo "❌ Invalid commit message format: $commit_msg"
              echo "Commit messages must follow conventional commit format:"
              echo "  <type>(<scope>): <subject>"
              echo "  Types: feat, fix, docs, style, refactor, test, chore"
              exit 1
            fi
          done <<< "$commits"
          
          echo "✅ All commit messages follow conventional commit format"
